# Conversion Response

Selected Model: [o3-mini (high)](https://platform.openai.com/docs/models/o3-mini)

## Metadata

### Token Summary
```
Instruction Tokens:                   24,982
Simulated User Prompt Tokens:         15,689
Simulated Assistent Response Tokens:   7,903
New User Prompt Tokens:                8,311
Total Tokens:                         81,885
Model Max Tokens:                    100,000

```

### Response Statistics
```
Response Time: 47.81s
Actual Usage:
{
  "input_tokens": 56962,
  "input_tokens_details": {
    "cached_tokens": 0
  },
  "output_tokens": 5376,
  "output_tokens_details": {
    "reasoning_tokens": 4032
  },
  "total_tokens": 62338
}
```

### Links
[View in OpenAI Dashboard](https://platform.openai.com/logs/resp_67dce7f7912c8190b264e34a7323fc8408f5979d8dc4a067)

## Response

```typescript
import { Annotations, Template } from "../../assertions";
import { App, CfnResource, Stack } from "../../core";
import { Group, ManagedPolicy, User } from "../../../src/aws/iam";

// IAM Groups tests using TerraConstructs
describe("IAM groups", () => {
  test("default group", () => {
    const app = new App();
    const stack = new Stack(app, "MyStack");
    new Group(stack, "MyGroup");

    // In TerraConstructs the IAM group resource is synthesized as aws_iam_group
    Template.synth(stack).hasResource("aws_iam_group", {});
  });

  test("users can be added to the group either via user.addToGroup or group.addUser", () => {
    const app = new App();
    const stack = new Stack(app, "MyStack");
    const group = new Group(stack, "MyGroup");
    const user1 = new User(stack, "User1");
    const user2 = new User(stack, "User2");
    user1.addToGroup(group);
    group.addUser(user2);

    // Check that the IAM group is created and both users contain a reference to the group in their Groups property.
    Template.synth(stack).toMatchObject({
      resource: {
        aws_iam_group: {
          // The actual logical id is generated by TerraConstructs; we only check that one exists.
        },
        aws_iam_user: {
          // Both user resources should include a "groups" property referencing the group.
          // Use Jest asymmetric matchers to check that the "groups" array contains a reference string
          User1: {
            groups: [expect.objectContaining({ Ref: expect.stringMatching(/MyGroup/) })],
          },
          User2: {
            groups: [expect.objectContaining({ Ref: expect.stringMatching(/MyGroup/) })],
          },
        },
      },
    });
  });

  test("create with managed policy", () => {
    const stack = new Stack();
    new Group(stack, "MyGroup", {
      managedPolicies: [ManagedPolicy.fromAwsManagedPolicyName("asdf")],
    });

    // Expect the synthesized IAM group to have a managed_policy_arns property.
    Template.synth(stack).hasResourceWithProperties("aws_iam_group", {
      managed_policy_arns: [
        {
          "Fn::Join": [
            "",
            ["arn:", { Ref: "AWS::Partition" }, ":iam::aws:policy/asdf"],
          ],
        },
      ],
    });
  });

  test("groups imported by group name have valid arn", () => {
    const stack = new Stack();
    const group1 = Group.fromGroupName(stack, "imported-group1", "MyGroupName1");
    const group2 = Group.fromGroupName(stack, "imported-group2", "division/MyGroupName2");

    expect(stack.resolve(group1.groupArn)).toStrictEqual({
      "Fn::Join": [
        "",
        [
          "arn:",
          { Ref: "AWS::Partition" },
          ":iam::",
          { Ref: "AWS::AccountId" },
          ":group/MyGroupName1",
        ],
      ],
    });
    expect(stack.resolve(group2.groupArn)).toStrictEqual({
      "Fn::Join": [
        "",
        [
          "arn:",
          { Ref: "AWS::Partition" },
          ":iam::",
          { Ref: "AWS::AccountId" },
          ":group/division/MyGroupName2",
        ],
      ],
    });
  });
});

test("cross-env group ARNs include path", () => {
  const app = new App();
  const groupStack = new Stack(app, "group-stack", {
    env: { account: "123456789012", region: "us-east-1" },
  });
  const referencerStack = new Stack(app, "referencer-stack", {
    env: { region: "us-east-2" },
  });
  const group = new Group(groupStack, "Group", {
    path: "/sample/path/",
    groupName: "sample-name",
  });
  new CfnResource(referencerStack, "Referencer", {
    type: "Custom::GroupReferencer",
    properties: { GroupArn: group.groupArn },
  });

  Template.synth(referencerStack).hasResourceWithProperties("Custom::GroupReferencer", {
    GroupArn: {
      "Fn::Join": [
        "",
        [
          "arn:",
          { Ref: "AWS::Partition" },
          ":iam::123456789012:group/sample/path/sample-name",
        ],
      ],
    },
  });
});

test("throw warning if attached managed policies exceed 10 in constructor", () => {
  const stack = new Stack();

  new Group(stack, "MyGroup", {
    groupName: "MyGroup",
    managedPolicies: [
      ManagedPolicy.fromAwsManagedPolicyName("0"),
      ManagedPolicy.fromAwsManagedPolicyName("1"),
      ManagedPolicy.fromAwsManagedPolicyName("2"),
      ManagedPolicy.fromAwsManagedPolicyName("3"),
      ManagedPolicy.fromAwsManagedPolicyName("4"),
      ManagedPolicy.fromAwsManagedPolicyName("5"),
      ManagedPolicy.fromAwsManagedPolicyName("6"),
      ManagedPolicy.fromAwsManagedPolicyName("7"),
      ManagedPolicy.fromAwsManagedPolicyName("8"),
      ManagedPolicy.fromAwsManagedPolicyName("9"),
      ManagedPolicy.fromAwsManagedPolicyName("10"),
    ],
  });

  Annotations.fromStack(stack).hasWarning("*", "You added 11 to IAM Group MyGroup. The maximum number of managed policies attached to an IAM group is 10. [ack: @aws-cdk/aws-iam:groupMaxPoliciesExceeded]");
});

test("throw warning if attached managed policies exceed 10 when calling addManagedPolicy", () => {
  const stack = new Stack();

  const group = new Group(stack, "MyGroup", {
    groupName: "MyGroup",
  });

  for (let i = 0; i <= 11; i++) {
    group.addManagedPolicy(ManagedPolicy.fromAwsManagedPolicyName(i.toString()));
  }

  Annotations.fromStack(stack).hasWarning(
    "/Default/MyGroup",
    "You added 12 to IAM Group MyGroup. The maximum number of managed policies attached to an IAM group is 10. [ack: @aws-cdk/aws-iam:groupMaxPoliciesExceeded]"
  );
});
```